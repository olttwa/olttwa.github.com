
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Load Balancing in gRPC for Frontend Backend Communication Part:1 - Akshat's Blog</title>
  <meta name="author" content="Akshat">

  
  <meta name="description" content="We needed a strategy for load balancing incoming requests from our user-facing applications (android and ios) for communication in gRPC. The reasons &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://olttwa.com/blog/2017/10/02/load-balancing-in-grpc-for-frontend-backend-communication-part-1/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Akshat's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-92993154-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Akshat's Blog</a></h1>
  
    <h2>I share my perception of Life, the Universe and Everything here.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="olttwa.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Load Balancing in gRPC for Frontend Backend Communication Part:1</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-10-02T23:51:56+05:30'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>11:51 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://olttwa.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>We needed a strategy for load balancing incoming requests from our user-facing applications (android and ios) for communication in <a href="http://grpc.io/">gRPC</a>. The reasons for choosing a strategy is mentioned here. Implementation details can be found in Part:2</p>

<!-- more -->


<h3>Need for gRPC</h3>

<p>I work at Go-Jek as a product engineer. Here we have multiple use-cases wherein gRPC would make more sense compared to the traditional REST api for communication between frontend-backend. Examples: Customer application live tracking a driver&rsquo;s location, recording location of a driver, chat sessions, etc. We are building a small feature which can even be implemented using REST api. But we decided to use this as an opportunity to explore gRPC.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<h3>Choosing a load balancing(LB) strategy</h3>

<p>I started from the official <a href="https://grpc.io/blog/loadbalancing">load balancing blog</a></p>

<h4>First decision</h4>

<p>The first decision was choosing between proxy or client side LB.</p>

<p>In <code>Proxy LB</code>, the clients themselves do not know about the backend servers. Clients can be untrusted. This architecture is typically used for user facing services where clients from open internet can connect to servers in a data center. In this scenario, clients make requests to LB. The LB passes on the request to one of the backends, and the backends report load to LB.</p>

<p>In <code>Client side LB</code>, the client is aware of multiple backend servers and chooses one to use for each RPC. The client gets load reports from backend servers and the client implements the LB algorithms. In simpler configurations server load is not considered and client can just round-robin between available servers.</p>

<p>This was an easy choice. I chose <code>Proxy side LB</code></p>

<p>Here are cons in <code>Client side LB</code></p>

<ul>
<li>Have to implement same logic in multiple languages</li>
<li>Client cannot be trusted</li>
<li>Client has to take care of service discovery</li>
</ul>


<p>For sake of balance, here are cons for <code>Proxy side LB</code></p>

<ul>
<li>LB is in the data path</li>
<li>Higher latency</li>
<li>LB throughput may limit scalability</li>
</ul>


<p>Sidenote: <code>Client Side Lookaside LB</code> may seem promising but still client will have a lot of logic which could easily be put into the LB.</p>

<h4>Second decision</h4>

<p>Now comes a very difficult choice: <code>Transport level LB</code> or <code>Application level LB</code></p>

<p>I chose <code>Transport level LB</code> because:</p>

<ul>
<li>RPC load doesn&rsquo;t vary a lot among connections (atleast for the current feature)</li>
<li>Latency is paramount. (Although for a frontend backend communication, I am sure a difference in a few milliseconds at LB level won&rsquo;t matter)</li>
<li>Far more complex code base for <code>Application level LB</code></li>
</ul>


<p>Some cons of <code>Application level LB</code> are:</p>

<ul>
<li>Difficult to scale</li>
<li>Requires very high performance hardware. (With the maturity of infrastructure at Go-Jek this is not an issue really, but is omttwaüòÖ)</li>
</ul>


<p>One major reason for choosing <code>Transport level LB</code> is that <code>Application level LB</code> would have been over-kill for us. For the current feature implementation, we don&rsquo;t need session stickiness which is one of the major reasons people choose <code>Application level LB</code></p>

<p>These blogs helped me weigh pros-cons of <code>Transport level LB</code> vs <code>Application level LB</code> <sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<h4>Third decision</h4>

<p>The highest amount of yak-shaving went in this decision. I knew in my heart all along that I&rsquo;d use envoyproxy as a LB. To be thorough, I went through a whole lot of blogs<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup> just to be completely sure.</p>

<p>I won&rsquo;t mention the reasons for not choosing HAProxy or NGINX. <a href="http://envoyproxy.github.io/">Envoyproxy</a> wins hands-down because it fit the following use-cases we needed:</p>

<ul>
<li>Our frontend application can switch to HTTP/1.1 based REST apis anytime it wantsüòç Envoy supports a gRPC bridge filter that allows gRPC requests to be sent to Envoy over HTTP/1.1. Envoy then translates the requests to HTTP/2 for transport to the target server. The response is translated back to HTTP/1.1<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup></li>
<li>If we decide to switch to <code>Application level LB</code>, only envoy has support for that in HTTP/2.</li>
<li>Future of Envoy is promising<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup></li>
<li>Has first class support for HTTP/2</li>
<li>Hot restarts</li>
<li>Multithreaded architecture</li>
<li>Service discovery. (Go-Jek is rapidly moving towards an architecture where service mesh is inevitable)</li>
</ul>


<p>In Part 2, I will illustrate a LB implemented using envoyproxy. WIP can be found here: <a href="https://github.com/olttwa/grpc-envoyproxy">github link</a></p>

<hr />

<hr />

<p>I hope this blog was helpful üòÄ. Please leave your thoughts in the comments section below. You can reach out to me on email: akshat.iitj‚öΩgmail.com</p>

<hr />
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Tech isn&rsquo;t putting business at risk just to explore new things. There is a fallback to REST incase gRPC fails. We are pretty mature that ways üòõ<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="https://devcentral.f5.com/articles/why-layer-7-load-balancing-doesnrsquot-suck">https://devcentral.f5.com/articles/why-layer-7-load-balancing-doesnrsquot-suck</a> <a href="http://wtarreau.blogspot.in/2006/11/making-applications-scalable-with-load.html">http://wtarreau.blogspot.in/2006/11/making-applications-scalable-with-load.html</a> <a href="https://www.loadbalancer.org/blog/why-layer-7-sucks/">https://www.loadbalancer.org/blog/why-layer-7-sucks/</a> <a href="https://serverfault.com/questions/233402/layer-4-vs-layer-7-load-balancing">https://serverfault.com/questions/233402/layer-4-vs-layer-7-load-balancing</a> <a href="https://www.nginx.com/resources/glossary/layer-4-load-balancing/">https://www.nginx.com/resources/glossary/layer-4-load-balancing/</a> <a href="https://www.nginx.com/resources/glossary/layer-7-load-balancing/">https://www.nginx.com/resources/glossary/layer-7-load-balancing/</a><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p><a href="https://medium.com/@copyconstruct/envoy-953c340c2dca">https://medium.com/@copyconstruct/envoy-953c340c2dca</a> <a href="https://githubengineering.com/introducing-glb/">https://githubengineering.com/introducing-glb/</a> <a href="https://githubengineering.com/glb-part-2-haproxy-zero-downtime-zero-delay-reloads-with-multibinder/">https://githubengineering.com/glb-part-2-haproxy-zero-downtime-zero-delay-reloads-with-multibinder/</a> <a href="https://www.microservices.com/talks/lyfts-envoy-monolith-service-mesh-matt-klein/">https://www.microservices.com/talks/lyfts-envoy-monolith-service-mesh-matt-klein/</a> <a href="http://blog.christianposta.com/microservices/00-microservices-patterns-with-envoy-proxy-series/">http://blog.christianposta.com/microservices/00-microservices-patterns-with-envoy-proxy-series/</a> <a href="https://eng.lyft.com/announcing-envoy-c-l7-proxy-and-communication-bus-92520b6c8191">https://eng.lyft.com/announcing-envoy-c-l7-proxy-and-communication-bus-92520b6c8191</a> <a href="https://eng.lyft.com/envoy-7-months-later-41986c2fd443">https://eng.lyft.com/envoy-7-months-later-41986c2fd443</a><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p><a href="https://envoyproxy.github.io/envoy/intro/arch_overview/grpc.html#arch-overview-grpc">https://envoyproxy.github.io/envoy/intro/arch_overview/grpc.html#arch-overview-grpc</a><a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p>There are 42 people working on this actively <a href="https://medium.com/@copyconstruct/envoy-953c340c2dca">https://medium.com/@copyconstruct/envoy-953c340c2dca</a><a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Akshat</span></span>

      




<time class='entry-date' datetime='2017-10-02T23:51:56+05:30'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2017</span></span> <span class='time'>11:51 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://olttwa.com/blog/2017/10/02/load-balancing-in-grpc-for-frontend-backend-communication-part-1/" data-via="akshatiitj" data-counturl="http://olttwa.com/blog/2017/10/02/load-balancing-in-grpc-for-frontend-backend-communication-part-1/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/09/30/quarter-summary-jul-sep-2017/" title="Previous Post: [Quarter Summary] Jul-Sep 2017">&laquo; [Quarter Summary] Jul-Sep 2017</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/10/02/load-balancing-in-grpc-for-frontend-backend-communication-part-1/">Load Balancing in gRPC for Frontend Backend Communication Part:1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/09/30/quarter-summary-jul-sep-2017/">[Quarter Summary] Jul-Sep 2017</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/08/21/article-summary-time-clocks-and-the-ordering-of-events-in-a-distributed-system/">[Article Summary] Time Clocks and the Ordering of Events in a Distributed System</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/17/humane-and-effective-ways-for-collecting-feedback/">Humane and Effective Ways for Collecting Feedback</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/03/17/o-dot-l-t-dot-t-w-dot-a/">o.l.t.t.w.a.</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/olttwa">@olttwa</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'olttwa',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Akshat -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'http-olttwa-com';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://olttwa.com/blog/2017/10/02/load-balancing-in-grpc-for-frontend-backend-communication-part-1/';
        var disqus_url = 'http://olttwa.com/blog/2017/10/02/load-balancing-in-grpc-for-frontend-backend-communication-part-1/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
